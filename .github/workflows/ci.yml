name: CI - Exercice_4

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  install:
    name: ğŸ“¦ Installer les dÃ©pendances
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Installation dans Exercice_4
        working-directory: ./Exercice_4
        run: npm install

  test:
    name: ğŸ§ª Lancer les tests
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: ğŸ“¦ Installer les dÃ©pendances
        working-directory: ./Exercice_4
        run: npm install
      - name: ğŸ§ª Tests unitaires/fonctionnels/E2E
        working-directory: ./Exercice_4
        run: npm run test:all

  coverage_and_check:
    name: ğŸ“Š GÃ©nÃ©rer et vÃ©rifier la couverture
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: ğŸ“¦ Installer les dÃ©pendances
        working-directory: ./Exercice_4
        run: npm install
      - name: ğŸ“Š Lancer la couverture + vÃ©rification
        working-directory: ./Exercice_4
        run: |
          echo "ğŸ“Š ExÃ©cution de Jest avec --coverage"
          npm run test:couverture

          echo "ğŸ” VÃ©rification de coverage-summary.json"
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "âŒ Le fichier coverage-summary.json est introuvable"
            exit 1
          fi

          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "ğŸ“ˆ Couverture actuelle : $COVERAGE %"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Couverture insuffisante (< 80%)"
            exit 1
          else
            echo "âœ… Couverture suffisante"
          fi

  upload:
    name: ğŸ“ Sauvegarder le rapport de couverture
    runs-on: ubuntu-latest
    needs: coverage_and_check
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“ Upload coverage/
        uses: actions/upload-artifact@v4
        with:
          name: couverture
          path: Exercice_4/coverage/

  rollback:
    name: ğŸ›‘ Rollback (en cas dâ€™Ã©chec)
    runs-on: ubuntu-latest
    if: failure()
    needs: [test, coverage_and_check]
    steps:
      - name: ğŸ” Rollback automatique ou alerte
        run: |
          echo "âŒ Ã‰chec dÃ©tectÃ© dans un job prÃ©cÃ©dent."
          echo "âª DÃ©clenchement d'une action de rollback..."

          # Exemple de rollback : suppression de fichiers, alerte, reset d'une branche...
          # echo "Rollback en cours..."
          # curl -X POST https://mon-vps/rollback-endpoint

          echo "ğŸš¨ Pense Ã  implÃ©menter ton rollback rÃ©el ici"

